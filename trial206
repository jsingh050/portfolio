import cv2
import numpy as np

# Open a connection to the webcam, default: 0
cap = cv2.VideoCapture(0)

# Read the first frame
ret, first_frame = cap.read()

# Convert the first frame to 8-bit grayscale
first_gray_frame = cv2.cvtColor(first_frame, cv2.COLOR_BGR2GRAY).astype(np.int8)

# Set parameters
#PIX_ON_THRESH = 10
#PIX_OFF_THRESH = -10
#changed the thresholds
PIX_ON_THRESH = 10
PIX_OFF_THRESH = -10


# Initialize video writers
fourcc = cv2.VideoWriter_fourcc(*'XVID')
output_original = cv2.VideoWriter('output_original.avi', fourcc, 20.0, (640, 480))
output_processed = cv2.VideoWriter('output_processed.avi', fourcc, 20.0, (640, 480), isColor=False)

while True:
    # Read the current frame
    ret, current_frame = cap.read()

    # Convert the current frame to 8-bit grayscale
    gray_frame = cv2.cvtColor(current_frame, cv2.COLOR_BGR2GRAY).astype(np.int8)

    # Compute the difference between the current and previous frames
    frame_diff = np.int8(gray_frame) - np.int8(first_gray_frame)

    # Apply a windowed threshold function
    events = np.zeros_like(frame_diff)
    events[frame_diff > PIX_ON_THRESH] = 1
    events[frame_diff < PIX_OFF_THRESH] = -1
    events[(frame_diff >= PIX_OFF_THRESH) & (frame_diff <= PIX_ON_THRESH)] = 0

    # Convert events back to uint8 for displaying
    events_display = np.uint8(events)

    # Display the resulting frame real-time
    cv2.imshow('Neuromorphic Vision', events_display)

    # Write original and processed frames to video files
    output_original.write(current_frame)
    output_processed.write(events_display)

    # Update the previous frame for the next iteration
    first_gray_frame = gray_frame.copy()

    # Break the loop if 'q' key is pressed
    if cv2.waitKey(1) & 0xFF == ord('q'):
        break

# Release resources
cap.release()
output_original.release()
output_processed.release()
cv2.destroyAllWindows()
